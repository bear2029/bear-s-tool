/*! ecom2 2015-08-12 */
var AppRouter=Backbone.Router.extend({routes:{"name/*nameJson":"changeName",name:"changeName"}}),appRouter=new AppRouter;Handlebars.registerHelper("json",function(a){if(_.isUndefined(a))return"";var b=JSON.stringify(a);return b}),Handlebars.registerHelper("strip",function(a){return"string"==typeof a?a.replace(/[`~]/g,""):a});var isMobile=/Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent),clickMethod=isMobile?"touchstart":"click",CharModel=Backbone.Model.extend({}),NameCombo=Backbone.Collection.extend({url:"/queue/nameCache",model:CharModel,initialize:function(){_.bindAll(this,"chi","eng")},chi:function(){return this.reduce(function(a,b){return a.push(b.get("chi")),a},[])},eng:function(){return this.reduce(function(a,b){return a.push(b.get("eng")),a},[])},toNameModel:function(){return new NameModel({chi:this.chi(),eng:this.eng()})}}),NameModel=Backbone.Model.extend({urlRoot:"/queue/nameCache/",equalTo:function(a){return!1},exchange:function(){var a=["chi","eng"];_.each(a,function(a){this[a]=[],_.each(this.get(a),function(b){this[a].unshift(b)}.bind(this)),this.set(a,this[a]),delete this[a]}.bind(this))},eng:function(){return this.get("eng").join("")},chi:function(){return this.get("chi").join("")},charModelAtIndex:function(a){return new CharModel({chi:this.get("chi")[a],eng:this.get("eng")[a]})}}),NameList=Backbone.Collection.extend({urlRoot:"/queue/nameCache/",url:"/queue/nameCache",model:NameModel}),CharCollection=Backbone.Collection.extend({model:CharModel,randomize:function(a,b){var c,d,e=8*a;do{c=0,d=new NameCombo;for(var f=0;a>f;f++){var g=b?new CharCollection(this.where({eng:b[f]})):this,h=Math.floor(Math.random()*g.length);d.add(g.at(h)),c+=10-g.at(h).get("index")}}while(e>c);return d}}),DictionaryModel=Backbone.Model.extend({urlRoot:"/dictionaryWrapper"}),CustomEditView=Backbone.View.extend({initialize:function(){this.template=Handlebars.compile($("#custom-edit-template").html()),_.bindAll(this,"render","onSubmit"),this.render(),this.attributes.parentEl.append(this.$el),this.$el.on("reset",function(a){$("#name-gen").removeClass("custom-edting")}),this.$el.on("submit",this.onSubmit),this.model.on("change",this.render)},onSubmit:function(a){a.preventDefault(),$("#name-gen").removeClass("custom-edting");var b=_.reduce($("input.free",this.$el),function(a,b){return b=$(b),b.hasClass("chi")?a.chi.push(b.val()):b.hasClass("eng")&&a.eng.push(b.val()),a},{chi:[],eng:[]});this.model.set(b)},render:function(){return this.$el.html($(this.template(this.model.toJSON()))),this}}),DictionaryView=Backbone.View.extend({initialize:function(){this.template=Handlebars.compile($("#dictionary-template").html()),_.bindAll(this,"render");var a=new DictionaryModel({id:this.attributes.str});a.fetch(),this.listenTo(a,"change",function(b){this.render({d:a.toJSON()})})},render:function(a){return this.$el&&this.$el.remove(),a.strokes=_.reduce(a.d,function(a,b){return b.c&&(a+=b.c),a},0),a.isMatchStrokes=[9,10,15,17,18,21,25,31].indexOf(a.strokes)>-1,a.isMatchStrokes||this.trigger("notMatch",this),this.$el=$(this.template(a)),this.attributes.parentEl.append(this.$el),$(".toggler",this.$el).on(clickMethod,function(){this.$el.toggleClass("expand")}.bind(this)),this}}),FavItemView=Backbone.View.extend({remove:function(){this.collection.remove(this.model),this.model.destroy(),this.$el.remove()},initialize:function(){this.template=Handlebars.compile($("#fav-item-template").html()),_.bindAll(this,"render","remove"),this.render(this.attributes.parentEl),this.attributes.parentEl.append(this.$el),this.dictionary=new DictionaryView({attributes:{parentEl:this.$el,str:this.model.chi()}}),$(".remove",this.$el).on(clickMethod,this.remove),$(".main",this.$el).on("click",function(){this.trigger("select",this.model)}.bind(this))},render:function(){var a={name:this.model.chi()};return this.$el=$(this.template(a)),this}}),NameGenView=Backbone.View.extend({initialize:function(){this.nameModel=new NameModel({chi:[],eng:[]}),this.customEditor=new CustomEditView({attributes:{parentEl:$(".generator .name-card",this.$el)},model:this.nameModel.clone()}),_.bindAll(this,"onSelectFav","onPinSelected","onPinPronounce","onCustom","urlChangeName","randomize","capture","onAddFavItem","rotate","rerender"),this.favItemViews=[],this.faviCollection=new NameList([]),this.faviCollection.fetch(),"/name"==location.pathname&&this.randomize(),this.isSelectingPin=!1,this.pinIndex=-1,this.isFixingPronounce=!1,this.listenTo(this.faviCollection,"add",this.onAddFavItem),this.nameModel.on("change",function(){var a=this.nameModel.toJSON();a=_.pick(a,"chi","eng"),appRouter.navigate("name/"+JSON.stringify(a)),this.rerender()}.bind(this)),this.customEditor.model.on("change",function(a){this.nameModel.set(a.toJSON())}.bind(this)),$("i",this.$el).on(clickMethod,this.randomize),$("em",this.$el).on(clickMethod,this.capture),$(".generator .main",this.$el).on(clickMethod,this.onPinSelected),$(".generator .name-card>h4",this.$el).on(clickMethod,this.onPinPronounce),$(".utils>.rotate",this.$el).on(clickMethod,this.rotate),$(".utils>.custom",this.$el).on(clickMethod,this.onCustom),appRouter.on("route:changeName",this.urlChangeName)},events:{},onCustom:function(){this.$el.addClass("custom-edting")},onPinPronounce:function(a){this.isFixingPronounce=!this.isFixingPronounce,this.synPinPronounceClass()},onPinSelected:function(a){var b=$(a.target),c=this.nameModel.chi().indexOf(b.html());this.pinIndex=c==this.pinIndex?-1:c,this.syncPinClass()},synPinPronounceClass:function(){var a=$(".generator .name-card>h4",this.$el);this.isFixingPronounce?a.addClass("selected"):a.removeClass("selected")},syncPinClass:function(){_.each($(".generator .main>span",this.$el),function(a,b){b==this.pinIndex?$(a).addClass("selected"):$(a).removeClass("selected")}.bind(this))},onAddFavItem:function(a){var b=this.faviCollection.indexOf(a);this.favItemViews[b]=new FavItemView({model:a,collection:this.faviCollection,attributes:{parentEl:$(".fav>ul",this.$el)}}),this.listenTo(this.favItemViews[b],"select",this.onSelectFav)},onSelectFav:function(a){this.nameModel.set(a.toJSON())},rotate:function(){this.nameModel.exchange()},capture:function(){this.faviCollection.contains(this.nameModel)||(this.faviCollection.add(this.nameModel),this.nameModel.save()),this.$el.addClass("favorite")},randomize:function(){var a,b;if(this.isFixingPronounce&&(a=this.nameModel.get("eng")),this.pinIndex>-1){b=this.collection.randomize(1,a);var c=0===this.pinIndex?"unshift":"add";b[c](this.nameModel.charModelAtIndex(this.pinIndex)),this.nameModel.set(b.toNameModel().toJSON())}else b=this.collection.randomize(2,a),this.nameModel.set(b.toNameModel().toJSON())},urlChangeName:function(a){this.nameModel.set(JSON.parse(a)),this.rerender()},render:function(){this.rerender()},rerender:function(){var a=this.faviCollection.contains(this.nameModel);a?this.$el.addClass("favorite"):this.$el.removeClass("favorite"),$("h3",this.$el).text(""),_.each(this.nameModel.chi(),function(a){$("h3",this.$el).append("<span>"+a+"</span>")}),$("h4",this.$el).text(this.nameModel.eng()),this.dictionary&&this.dictionary.remove(),this.dictionary=new DictionaryView({attributes:{parentEl:$(".generator .name-card",this.$el),str:this.nameModel.chi()}}),this.syncPinClass(),this.synPinPronounceClass(),this.customEditor.model.set(this.nameModel.toJSON())}}),charCollection=new CharCollection([]);_.each(nameBases,function(a){charCollection.add(new CharModel(a))},[]);var nameGenView=new NameGenView({collection:charCollection,el:$("#name-gen")});Backbone.history.start({pushState:!0});