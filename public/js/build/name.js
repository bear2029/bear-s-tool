/*! ecom2 2015-06-11 */
var AppRouter=Backbone.Router.extend({routes:{"name/*nameJson":"changeName"}}),app_router=new AppRouter;Handlebars.registerHelper("json",function(a){if(_.isUndefined(a))return"";var b=JSON.stringify(a);return b}),Handlebars.registerHelper("strip",function(a){return"string"==typeof a?a.replace(/[`~]/g,""):a});var isMobile=/Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent),clickMethod=isMobile?"touchstart":"click",CharModel=Backbone.Model.extend({}),NameCombo=Backbone.Collection.extend({url:"/queue/nameCache",model:CharModel,initialize:function(){_.bindAll(this,"chi","eng")},chi:function(){return this.reduce(function(a,b){return a.push(b.get("chi")),a},[])},eng:function(){return this.reduce(function(a,b){return a.push(b.get("eng")),a},[])},toNameModel:function(){return new NameModel({chi:this.chi(),eng:this.eng()})}}),NameModel=Backbone.Model.extend({urlRoot:"/queue/nameCache/",equalTo:function(a){return!1},exchange:function(){var a=["chi","eng"];_.each(a,function(a){this[a]=[],_.each(this.get(a),function(b){this[a].unshift(b)}.bind(this)),this.set(a,this[a]),delete this[a]}.bind(this))},eng:function(){return this.get("eng").join("")},chi:function(){return this.get("chi").join("")},charModelAtIndex:function(a){return new CharModel({chi:this.get("chi")[a],eng:this.get("eng")[a]})}}),NameList=Backbone.Collection.extend({urlRoot:"/queue/nameCache/",url:"/queue/nameCache",model:NameModel}),CharCollection=Backbone.Collection.extend({model:CharModel,prioritize:function(){},randomize:function(a,b){var c=8*a;do for(var d=0,e=new NameCombo,f=0;a>f;f++){var g=b?new CharCollection(this.where({eng:b[f]})):this,h=Math.floor(Math.random()*g.length);e.add(g.at(h)),d+=10-g.at(h).get("index")}while(c>d);return e}}),DictionaryModel=Backbone.Model.extend({urlRoot:"/dictionaryWrapper"}),DictionaryView=Backbone.View.extend({template:Handlebars.compile($("#dictionary-template").html()),initialize:function(){_.bindAll(this,"render");var a=new DictionaryModel({id:this.attributes.str});a.fetch(),this.listenTo(a,"change",function(b){this.render({d:a.toJSON()})})},render:function(a){return this.$el&&this.$el.remove(),this.$el=$(this.template(a)),this.attributes.parentEl.append(this.$el),$(".toggler",this.$el).on(clickMethod,function(){this.$el.toggleClass("expand")}.bind(this)),this}}),FavItemView=Backbone.View.extend({template:Handlebars.compile($("#fav-item-template").html()),remove:function(){this.collection.remove(this.model),this.model.destroy(),this.$el.remove()},initialize:function(){_.bindAll(this,"render","remove"),this.render(this.attributes.parentEl),this.attributes.parentEl.append(this.$el),this.dictionary=new DictionaryView({attributes:{parentEl:this.$el,str:this.model.chi()}}),$(".remove",this.$el).on(clickMethod,this.remove),$(".main",this.$el).on("click",function(){this.trigger("select",this.model)}.bind(this))},render:function(){var a={name:this.model.chi()};return this.$el=$(this.template(a)),this}}),NameGenView=Backbone.View.extend({initialize:function(){_.bindAll(this,"onSelectFav","onPinSelected","onPinPronounce","urlChangeName","randomize","capture","onAddFavItem","rotate","rerender"),this.favItemViews=[],this.faviCollection=new NameList([]),this.faviCollection.fetch(),"/name"==location.pathname&&this.randomize(),this.isSelectingPin=!1,this.pinIndex=-1,this.isFixingPronounce=!1,this.listenTo(this.faviCollection,"add",this.onAddFavItem),$("i",this.$el).on(clickMethod,this.randomize),$("em",this.$el).on(clickMethod,this.capture),$(".generator .main",this.$el).on(clickMethod,this.onPinSelected),$(".generator .name-card>h4",this.$el).on(clickMethod,this.onPinPronounce),$(".utils>.rotate",this.$el).on(clickMethod,this.rotate),app_router.on("route:changeName",this.urlChangeName)},onPinPronounce:function(a){this.isFixingPronounce=!this.isFixingPronounce,this.synPinPronounceClass()},onPinSelected:function(a){var b=$(a.target),c=this.nameModel.chi().indexOf(b.html());this.pinIndex=c==this.pinIndex?-1:c,this.syncPinClass()},synPinPronounceClass:function(){var a=$(".generator .name-card>h4",this.$el);this.isFixingPronounce?a.addClass("selected"):a.removeClass("selected")},syncPinClass:function(){_.each($(".generator .main>span",this.$el),function(a,b){b==this.pinIndex?$(a).addClass("selected"):$(a).removeClass("selected")}.bind(this))},onAddFavItem:function(a){var b=this.faviCollection.indexOf(a);this.favItemViews[b]=new FavItemView({model:a,collection:this.faviCollection,attributes:{parentEl:$(".fav>ul",this.$el)}}),this.listenTo(this.favItemViews[b],"select",this.onSelectFav)},onSelectFav:function(a){this.nameModel=a,this.rerender()},rotate:function(){this.nameModel.exchange(),this.rerender()},capture:function(){this.faviCollection.contains(this.nameModel)||(this.faviCollection.add(this.nameModel),this.nameModel.save()),this.$el.addClass("favorite")},randomize:function(){var a;if(this.isFixingPronounce&&(a=this.nameModel.get("eng")),this.pinIndex>-1){var b=this.collection.randomize(1,a),c=0==this.pinIndex?"unshift":"add";b[c](this.nameModel.charModelAtIndex(this.pinIndex)),this.nameModel=b.toNameModel()}else{var b=this.collection.randomize(2,a);this.nameModel=b.toNameModel()}this.rerender()},urlChangeName:function(a){this.nameModel=new NameModel(JSON.parse(a)),this.rerender()},rerender:function(){var a=this.faviCollection.contains(this.nameModel);a?this.$el.addClass("favorite"):this.$el.removeClass("favorite"),$("h3",this.$el).text(""),_.each(this.nameModel.chi(),function(a){$("h3",this.$el).append("<span>"+a+"</span>")}),$("h4",this.$el).text(this.nameModel.eng()),this.dictionary&&this.dictionary.remove(),this.dictionary=new DictionaryView({attributes:{parentEl:$(".generator .name-card",this.$el),str:this.nameModel.chi()}}),this.syncPinClass(),this.synPinPronounceClass(),setTimeout(function(){console.log("reg",this.nameModel.toJSON()),app_router.navigate("name/"+JSON.stringify(this.nameModel.toJSON()))}.bind(this),100)}}),charCollection=new CharCollection([]);_.each(nameBases,function(a){charCollection.add(new CharModel(a))},[]);var nameGenView=new NameGenView({collection:charCollection,el:$("#name-gen")});Backbone.history.start({pushState:!0});